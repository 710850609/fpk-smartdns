name: release fpk

on:
  push:
    tags:
      - '*'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:  
  setup:
    runs-on: ubuntu-latest
    outputs:
      prerelease: ${{ steps.set-prerelease.outputs.prerelease }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set prerelease info
        id: set-prerelease
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF##*/}"
          elif [[ "${GITHUB_REF}" == refs/heads/main ]]; then
            TAG="main"
          else
            TAG="run-${GITHUB_RUN_NUMBER}"
          fi
          
          if [[ "$TAG" == run-* ]] || [[ "${TAG}" == *dev* ]] || [[ "${TAG}" == *pre* ]] || [[ "${TAG}" == *beta* ]]; then
            PRE=true
          else
            PRE=false
          fi
          echo "当次构建是否prerelease: $PRE"
          echo "prerelease=$PRE" >> $GITHUB_OUTPUT

  build-multi-arch:
    needs: setup
    outputs:
      release_version: ${{ steps.release-version.outputs.version }}
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
          - arch: aarch64
            runner: ubuntu-latest
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run build
        run: |
          echo "开始构建架构: ${{ matrix.arch }}, prerelease: ${{ needs.setup.outputs.prerelease }}"
          chmod +x ./fnpack.sh 2>/dev/null || true
          chmod +x ./build.sh 2>/dev/null || true
          ./build.sh arch=${{ matrix.arch }} build_pre="${{ needs.setup.outputs.prerelease }}" build_all="true" download_proxy="false" 2>/dev/null || true

      - name: Prepare artifact
        run: |
          FPK_FILE=$(ls *.fpk 2>/dev/null | head -1)
          if [ -z "$FPK_FILE" ]; then
            echo "错误：未找到.fpk文件"
            ls -la
            exit 1
          fi
          
          mkdir -p release
          cp "$FPK_FILE" "release/$FPK_FILE"
          echo "准备完成: $FPK_FILE"
          # if [ "${{ needs.setup.outputs.prerelease }}" == "true" ]; then
          #   cp "$FPK_FILE" "release/$FPK_FILE"
          #   echo "准备完成: $FPK_FILE"
          # else
          #   # 正式版去除版本号
          #   NEW_FPK_NAME="smartdns-${{ matrix.arch }}.fpk"
          #   cp "$FPK_FILE" "release/$NEW_FPK_NAME"
          #   echo "准备完成: $NEW_FPK_NAME"
          # fi

      - name: Get release version
        id: release-version
        run: |
          FPK_FILE=$(ls *.fpk 2>/dev/null | head -1)
          if [ -z "$FPK_FILE" ]; then
            echo "错误：未找到.fpk文件"
            ls -la
            echo "version='0-error'" >> $GITHUB_OUTPUT
            exit 1
          fi
          # 读取版本号
          version=$(sed -n 's/^[[:space:]]*version[[:space:]]*=[[:space:]]*//p' ./smartdns/manifest | sed 's/^"\|"$//g')
          echo "构建FPK版本: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fpk-${{ matrix.arch }}
          path: release/
          retention-days: 1

  create-release:
    needs: 
      - setup
      - build-multi-arch
    runs-on: ubuntu-latest
    steps:
      - name: Create release directory
        run: |
          mkdir -p combined-release
    
      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: fpk-x86_64
          path: combined-release

      - name: Download aarch64 artifact
        uses: actions/download-artifact@v4
        with:
          name: fpk-aarch64
          path: combined-release

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          name: ${{ needs.build-multi-arch.outputs.release_version }}
          tag: "release/${{ needs.build-multi-arch.outputs.release_version }}"
          artifacts: "combined-release/*"
          prerelease: ${{ needs.setup.outputs.prerelease }}
          skipIfReleaseExists: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release summary
        if: always()
        run: |
          echo "=== 发布总结 ==="
          echo "代码分支/标签: release/${{ needs.build-multi-arch.outputs.release_version }}"
          echo "版本:  ${{ needs.build-multi-arch.outputs.release_version }}"
          echo "预发布: ${{ needs.setup.outputs.prerelease }}"
          echo "包含的文件:"
          ls -la combined-release/
          echo "================"